#!/bin/bash
# Begin

# How to run this script.

# Step 1:        bash pentest-script.sh --email "<email>"         --openapispecurl "<Open APi Spec URL>"
# Example usage: bash pentest-script.sh --email "admin@apisec.ai" --openapispecurl "http://application.apisec.ai:8080/v2/api-docs" 

FX_OpenAPISpec=$1
FX_EMAIL=$2
OUTPUT_FILENAME=$3

echo " "
echo OpenAPISpecUrl: $FX_OpenAPISpec
echo Email-ID: $FX_EMAIL
echo " "

projectName=$(curl --location --request POST 'https://pentest.apisec.ai/api/v1/pentest' --header 'Content-Type: application/json' --data-raw '{     "openAPISpec": "'${FX_OpenAPISpec}'",     "email": "'${FX_EMAIL}'",     "source": "Github-Action"  }'| jq -r '.["data"].name')
echo " "
echo " "
echo "Pentest script execution is completed!!!"

echo ProjectName: $projectName

if [ "$OUTPUT_FILENAME" != "" ];
   then
   sarifoutput=$(curl -G 'https://pentest.apisec.ai/api/v1/sarif' --data-urlencode "projectName=$projectName" | jq '.["data"]')
   echo $sarifoutput
   echo $sarifoutput >> $GITHUB_WORKSPACE/$OUTPUT_FILENAME
   echo "SARIF output file created successfully"
fi
